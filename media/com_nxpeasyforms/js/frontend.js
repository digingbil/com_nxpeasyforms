class m{constructor(){this.cache=new Map}load(e){return this.cache.has(e)||this.cache.set(e,new Promise((t,s)=>{const r=document.createElement("script");r.src=e,r.async=!0,r.defer=!0,r.onload=()=>t(),r.onerror=()=>s(new Error(`Failed to load ${e}`)),document.head.appendChild(r)})),this.cache.get(e)}loadCaptchaScript(e,t){const r={recaptcha_v3:a=>this.load(`https://www.google.com/recaptcha/api.js?render=${encodeURIComponent(a)}`),turnstile:()=>this.load("https://challenges.cloudflare.com/turnstile/v0/api.js"),friendlycaptcha:()=>this.load("https://cdn.jsdelivr.net/npm/friendly-challenge@0.9.8/widget.min.js")}[e];return!r||e==="recaptcha_v3"&&!t?Promise.resolve():r(t)}}class y{constructor(e,t){this.wrapper=e,this.formElement=e.querySelector(".nxp-easy-form__form"),this.formId=Number(e.dataset.formId||0),this.messageEl=this.formElement.querySelector(".nxp-easy-form__messages"),this.submitButton=this.formElement.querySelector(".nxp-easy-form__submit"),this.config=t,this.restUrl=t.restUrl,this.successMessage=this.formElement.dataset.successMessage||t.successMessage||"Thanks!",this.errorMessage=this.formElement.dataset.errorMessage||t.errorMessage||"Submission failed. Please try again.",this.captchaConfig={provider:e.dataset.captchaProvider||"none",siteKey:e.dataset.captchaSiteKey||""},this.scriptLoader=t.scriptLoader,this.isSubmitting=!1,this.isLoginForm=e.dataset.isLoginForm==="1",this.init()}init(){this.captchaConfig.provider!=="none"&&this.scriptLoader.loadCaptchaScript(this.captchaConfig.provider,this.captchaConfig.siteKey).catch(()=>{}),this.formElement.addEventListener("submit",e=>this.handleSubmit(e))}async handleSubmit(e){var t,s;e.preventDefault(),this.clearMessages(),this.clearErrors(),this.setSubmitting(!0);try{const{data:r,files:a}=this.buildPayload(),n=await this.attachCaptchaToken(r);if(n!==!0){const h=typeof n=="string"?n:this.config.captchaFailedMessage;this.showMessage("error",h),requestAnimationFrame(()=>this.focusFirstInvalid());return}r.formId=this.formId;const o=this.buildRequestOptions(r,a),i=this.isLoginForm?`${window.location.origin}/index.php?option=com_nxpeasyforms&task=login.submit&format=json`:`${this.restUrl}/submission`,d=await fetch(i,o),c=await d.json().catch(()=>({})),l=c.data||c;if(!(d.ok&&(c.success||l.success))){const h=((t=l==null?void 0:l.errors)==null?void 0:t.fields)||((s=c==null?void 0:c.errors)==null?void 0:s.fields);h&&this.applyErrors(h);const f=l.message||c.message||this.errorMessage;this.showMessage("error",f),requestAnimationFrame(()=>this.focusFirstInvalid());return}if(this.showMessage("success",l.message||c.message||this.successMessage),this.formElement.reset(),this.resetCaptcha(),this.isLoginForm&&(l.redirect||c.redirect)){const h=l.redirect||c.redirect;setTimeout(()=>{window.location.href=h},1e3)}}catch{this.showMessage("error",this.errorMessage)}finally{this.setSubmitting(!1)}}buildPayload(){const e=new FormData(this.formElement),t={},s={},r={};return e.forEach((a,n)=>{a instanceof File?a&&a.name&&(s[n]=a):t[n]=a}),this.formElement.querySelectorAll('input[type="checkbox"][name]').forEach(a=>{const n=a.name;if(r[n]||(r[n]={total:0,values:[]}),r[n].total+=1,a.checked){const o=a.value||"on";r[n].values.push(o)}!a.checked&&r[n].total===1&&!(n in t)&&(t[n]=!1)}),Object.entries(r).forEach(([a,n])=>{n.total>1?t[a]=n.values:t[a]=n.values.length>0}),this.formElement.querySelectorAll("select[multiple][name]").forEach(a=>{const n=Array.from(a.selectedOptions).map(o=>o.value);t[a.name]=n}),Object.keys(s).forEach(a=>{delete t[a]}),{data:t,files:s}}buildRequestOptions(e,t){if(!(Object.keys(t).length>0))return{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)};const r=new FormData;return r.append("payload",JSON.stringify(e)),Object.entries(t).forEach(([a,n])=>{r.append(`files[${a}]`,n)}),{method:"POST",body:r}}async attachCaptchaToken(e){return!this.captchaConfig||this.captchaConfig.provider==="none"?(delete e._nxp_captcha_token,delete e._nxp_captcha_provider,!0):(e._nxp_captcha_provider=this.captchaConfig.provider,this.captchaConfig.provider==="recaptcha_v3"?await this.handleRecaptchaV3(e):this.captchaConfig.provider==="turnstile"?this.handleTurnstile(e):this.captchaConfig.provider==="friendlycaptcha"?this.handleFriendlyCaptcha(e):!0)}async handleRecaptchaV3(e){if(!this.captchaConfig.siteKey)return this.config.captchaFailedMessage;try{if(await this.scriptLoader.loadCaptchaScript("recaptcha_v3",this.captchaConfig.siteKey),!window.grecaptcha||!window.grecaptcha.execute)return this.config.captchaFailedMessage;const t=await new Promise((r,a)=>{window.grecaptcha.ready(()=>{window.grecaptcha.execute(this.captchaConfig.siteKey,{action:"nxp_easy_forms_submit"}).then(r).catch(a)})});if(!t)return this.config.captchaFailedMessage;e._nxp_captcha_token=t;const s=this.formElement.querySelector('input[name="_nxp_captcha_token"]');return s&&(s.value=t),!0}catch{return this.config.captchaFailedMessage}}async handleTurnstile(e){await this.scriptLoader.loadCaptchaScript("turnstile");const t=this.formElement.querySelector('input[name="cf-turnstile-response"]'),s=(e["cf-turnstile-response"]||(t==null?void 0:t.value)||"").trim();if(!s)return this.config.captchaIncompleteMessage;e._nxp_captcha_token=s,delete e["cf-turnstile-response"];const r=this.formElement.querySelector('input[name="_nxp_captcha_token"]');return r&&(r.value=s),!0}async handleFriendlyCaptcha(e){var r,a;await this.scriptLoader.loadCaptchaScript("friendlycaptcha");const t=(e["frc-captcha-response"]||e["frc-captcha-solution"]||((r=this.formElement.querySelector('input[name="frc-captcha-response"]'))==null?void 0:r.value)||((a=this.formElement.querySelector('input[name="frc-captcha-solution"]'))==null?void 0:a.value)||"").trim();if(!t)return this.config.captchaIncompleteMessage;e._nxp_captcha_token=t,delete e["frc-captcha-response"],delete e["frc-captcha-solution"];const s=this.formElement.querySelector('input[name="_nxp_captcha_token"]');return s&&(s.value=t),!0}resetCaptcha(){var t,s,r;if(!this.captchaConfig||this.captchaConfig.provider==="none")return;if(this.captchaConfig.provider==="turnstile"&&((t=window.turnstile)!=null&&t.reset)&&window.turnstile.reset(),this.captchaConfig.provider==="friendlycaptcha"&&((r=(s=window.friendlyChallenge)==null?void 0:s.widgets)!=null&&r.reset))try{window.friendlyChallenge.widgets.reset()}catch{}const e=this.formElement.querySelector('input[name="_nxp_captcha_token"]');e&&(e.value="")}showMessage(e,t){if(!this.messageEl)return;this.messageEl.innerHTML="";const s=document.createElement("div");s.className=`nxp-easy-form__notice nxp-easy-form__notice--${e}`,s.id=`nxp-ef-message-${this.formId}`,s.setAttribute("role","status"),s.setAttribute("tabindex","-1"),s.textContent=t,this.messageEl.appendChild(s),requestAnimationFrame(()=>{s.scrollIntoView({behavior:"smooth",block:"nearest"}),setTimeout(()=>{s.focus({preventScroll:!0})},300)})}clearMessages(){this.messageEl&&(this.messageEl.innerHTML="")}setSubmitting(e){this.isSubmitting=e,this.submitButton&&(this.submitButton.disabled=e),this.wrapper.classList.toggle("nxp-easy-form--submitting",e)}applyErrors(e){let t=!1;Object.entries(e).forEach(([s,r])=>{var o;const a=this.formElement.querySelector(`[data-error-for="${this.escapeSelector(s)}"]`)||this.ensureErrorHolder(s);if(!a)return;t=!0;const n=this.formElement.querySelector(this.getFieldSelector(s));if(n){n.setAttribute("aria-invalid","true");const i=this.ensureErrorId(a,n);n.setAttribute("aria-describedby",i)}a.textContent=r,(o=a.closest(".nxp-easy-form__group"))==null||o.classList.add("nxp-easy-form__group--error")}),t&&requestAnimationFrame(()=>this.focusFirstInvalid())}clearErrors(){this.formElement.querySelectorAll(".nxp-easy-form__group--error").forEach(e=>{e.classList.remove("nxp-easy-form__group--error")}),this.formElement.querySelectorAll(".nxp-easy-form__error").forEach(e=>{const t=this.formElement.querySelector(this.getFieldSelector(e.dataset.errorFor));t&&(t.removeAttribute("aria-invalid"),t.getAttribute("aria-describedby")===e.id&&t.removeAttribute("aria-describedby")),e.textContent=""})}ensureErrorHolder(e){const t=this.formElement.querySelector(this.getFieldSelector(e)),s=t==null?void 0:t.closest(".nxp-easy-form__group");if(!s)return null;const r=document.createElement("p");return r.className="nxp-easy-form__error",r.dataset.errorFor=e,r.setAttribute("role","alert"),s.appendChild(r),r}ensureErrorId(e,t){if(e.id)return e.id;const a=`${(t.id||t.name||"nxp-ef-field").replace(/[^a-z0-9_-]/gi,"")||"nxp-ef-field"}-error`;return e.id=a,a}focusFirstInvalid(){const e=this.formElement.querySelector('[aria-invalid="true"]');e&&e.focus({preventScroll:!1})}getFieldSelector(e){const t=this.escapeSelector(e);return`[name="${t}"], [id="${t}"]`}escapeSelector(e){var t;return(t=window.CSS)!=null&&t.escape?window.CSS.escape(String(e)):String(e).replace(/([ #;?%&,.+*~':"!^$\[\]\\(){}|<>@])/g,"\\$1")}}class g{constructor(e){this.restUrl=e,this.cache={countries:{},states:{}},this._debug=typeof window<"u"&&!!(window.nxpEasyFormsFrontend&&window.nxpEasyFormsFrontend.debug===!0),this._dbg=(...t)=>{this._debug&&console&&console.debug&&console.debug(...t)},this.init()}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.initFields()):this.initFields()}initFields(){document.querySelectorAll(".nxp-easy-form__country").forEach(s=>this.initCountryField(s)),document.querySelectorAll(".nxp-easy-form__state").forEach(s=>this.initStateField(s))}async initCountryField(e){var r;const t=e.dataset.countryFilter||"all",s=((r=e.querySelector('option[value=""]'))==null?void 0:r.textContent)||"Select a country";try{const a=await this.fetchCountries(t);this.populateCountrySelect(e,a,s),e.addEventListener("change",()=>this.handleCountryChange(e))}catch(a){this._dbg("[Country] Failed to load countries:",a)}}async initStateField(e){let t=e.dataset.countryField;this._dbg("[State] Initializing field, linked to country field:",t);const s=e.closest("form");if(!s){console.warn("[State] No parent form found");return}if(!t){const a=s.querySelectorAll(".nxp-easy-form__country");if(a.length===1&&(t=a[0].getAttribute("name")||"",t&&(e.dataset.countryField=t)),!t){const o=(e.getAttribute("name")||"").match(/^(.*)_state$/);if(o&&o[1]){const i=`${o[1]}_country`;s.querySelector(`[name="${i}"]`)&&(t=i,e.dataset.countryField=t)}}}if(!t){console.warn("[State] No country field specified in data-country-field and auto-link failed");return}const r=s.querySelector(`[name="${t}"]`);if(!r){console.warn("[State] Country field not found:",t);return}r.value&&await this.loadStatesForCountry(e,r.value)}async handleCountryChange(e){const t=e.value,s=e.closest("form");if(!s){console.warn("[Country] No parent form found");return}const r=e.getAttribute("name"),a=s.querySelectorAll(`.nxp-easy-form__state[data-country-field="${r}"]`),n=s.querySelectorAll(`input[data-original-select-html][data-country-field="${r}"]`);let o=[...a,...n];if(!o.length){const i=s.querySelectorAll(".nxp-easy-form__state"),d=s.querySelectorAll("input[data-original-select-html]"),c=s.querySelectorAll(".nxp-easy-form__country");if(i.length+d.length===1&&c.length===1){const p=i[0]||d[0];p.dataset.countryField=r||"",o=[p]}}o.forEach(async i=>{t?await this.loadStatesForCountry(i,t):this.clearStateField(i)})}async loadStatesForCountry(e,t){var a;const s=((a=e.querySelector('option[value=""]'))==null?void 0:a.textContent)||"Select a state",r=e.dataset.allowText==="1";try{const n=await this.fetchStates(t);if(Object.keys(n).length>0){const o=this.ensureSelectMode(e);this.populateStateSelect(o,n,s)}else r?this.convertToTextInput(e):(this.clearStateField(e),e.disabled=!0)}catch(n){this._dbg("Failed to load states:",n)}}async fetchCountries(e="all"){const t=e;if(this.cache.countries[t])return this.cache.countries[t];const r=await(await fetch(`${this.restUrl}/utility/countries?mode=${e}`)).json();return r.success&&r.countries?(this.cache.countries[t]=r.countries,r.countries):{}}async fetchStates(e){const t=String(e||"").toUpperCase();if(!t||t.length!==2)return{};if(this.cache.states[t])return this.cache.states[t];const s=await fetch(`${this.restUrl}/utility/states/${t}`,{headers:{Accept:"application/json"},credentials:"same-origin"});if(!s.ok)return this._dbg("[State] HTTP error when fetching states:",s.status,s.statusText),{};const r=await s.json().catch(()=>({}));return r&&r.success&&r.states&&typeof r.states=="object"?(this.cache.states[t]=r.states,r.states):{}}populateCountrySelect(e,t,s){for(;e.firstChild;)e.removeChild(e.firstChild);const r=document.createElement("option");r.value="",r.textContent=s,e.appendChild(r),Object.entries(t).forEach(([a,n])=>{const o=document.createElement("option");o.value=a,o.textContent=n,e.appendChild(o)})}populateStateSelect(e,t,s){for(;e.firstChild;)e.removeChild(e.firstChild);const r=document.createElement("option");r.value="",r.textContent=s,e.appendChild(r),Object.entries(t).forEach(([a,n])=>{const o=document.createElement("option");o.value=a,o.textContent=n,e.appendChild(o)}),e.disabled=!1}clearStateField(e){var r;if(!e)return;if(e.tagName==="INPUT"){e.value="";return}const t=((r=e.querySelector('option[value=""]'))==null?void 0:r.textContent)||"Select a state";for(;e.firstChild;)e.removeChild(e.firstChild);const s=document.createElement("option");s.value="",s.textContent=t,e.appendChild(s),e.value=""}convertToTextInput(e){var s;const t=document.createElement("input");t.type="text",t.name=e.name,t.id=e.id,t.className=e.className.replace("nxp-easy-form__state","nxp-easy-form__input"),t.placeholder=((s=e.querySelector('option[value=""]'))==null?void 0:s.textContent)||"",t.required=e.hasAttribute("required"),t.dataset.originalSelectHtml=e.outerHTML,e.dataset.countryField&&(t.dataset.countryField=e.dataset.countryField),e.dataset.allowText&&(t.dataset.allowText=e.dataset.allowText),e.parentNode.replaceChild(t,e)}ensureSelectMode(e){if(e.tagName==="INPUT"&&e.dataset.originalSelectHtml){const r=new DOMParser().parseFromString(e.dataset.originalSelectHtml,"text/html").body.firstElementChild;if(r&&r.tagName==="SELECT"){const a=r.cloneNode(!0);return a.querySelectorAll("script").forEach(n=>n.remove()),a.removeAttribute("onload"),a.removeAttribute("onerror"),a.removeAttribute("onclick"),e.parentNode.replaceChild(a,e),a}}return e}}(()=>{var a;const u=document.querySelectorAll(".nxp-easy-form");if(!u.length)return;const e=window.nxpEasyFormsFrontend||{},t=((a=window.wpApiSettings)==null?void 0:a.root)||`${window.location.origin}/wp-json/`,s=e.restUrl||`${t.replace(/\/$/,"")}/nxp-easy-forms/v1`,r={restUrl:s,successMessage:e.successMessage||"Thanks!",errorMessage:e.errorMessage||"Submission failed. Please try again.",captchaFailedMessage:e.captchaFailedMessage||"Security verification failed. Please try again.",captchaIncompleteMessage:e.captchaIncompleteMessage||"Please complete the verification.",scriptLoader:new m};new g(s),u.forEach(n=>{if(n.dataset.nxpEfBooted==="1")return;const o=n.querySelector(".nxp-easy-form__form"),i=Number(n.dataset.formId||0);!o||!s||!i||(n.dataset.nxpEfBooted="1",new y(n,r))})})();
