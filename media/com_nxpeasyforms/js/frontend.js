class f{constructor(){this.cache=new Map}load(e){return this.cache.has(e)||this.cache.set(e,new Promise((t,r)=>{const s=document.createElement("script");s.src=e,s.async=!0,s.defer=!0,s.onload=()=>t(),s.onerror=()=>r(new Error(`Failed to load ${e}`)),document.head.appendChild(s)})),this.cache.get(e)}loadCaptchaScript(e,t){const s={recaptcha_v3:a=>this.load(`https://www.google.com/recaptcha/api.js?render=${encodeURIComponent(a)}`),turnstile:()=>this.load("https://challenges.cloudflare.com/turnstile/v0/api.js"),friendlycaptcha:()=>this.load("https://cdn.jsdelivr.net/npm/friendly-challenge@0.9.8/widget.min.js")}[e];return!s||e==="recaptcha_v3"&&!t?Promise.resolve():s(t)}}class m{constructor(e,t){this.wrapper=e,this.formElement=e.querySelector(".nxp-easy-form__form"),this.formId=Number(e.dataset.formId||0),this.messageEl=this.formElement.querySelector(".nxp-easy-form__messages"),this.submitButton=this.formElement.querySelector(".nxp-easy-form__submit"),this.config=t,this.restUrl=t.restUrl,this.successMessage=this.formElement.dataset.successMessage||t.successMessage||"Thanks!",this.errorMessage=this.formElement.dataset.errorMessage||t.errorMessage||"Submission failed. Please try again.",this.captchaConfig={provider:e.dataset.captchaProvider||"none",siteKey:e.dataset.captchaSiteKey||""},this.scriptLoader=t.scriptLoader,this.isSubmitting=!1,this.init()}init(){this.captchaConfig.provider!=="none"&&this.scriptLoader.loadCaptchaScript(this.captchaConfig.provider,this.captchaConfig.siteKey).catch(()=>{}),this.formElement.addEventListener("submit",e=>this.handleSubmit(e))}async handleSubmit(e){var t,r;e.preventDefault(),this.clearMessages(),this.clearErrors(),this.setSubmitting(!0);try{const{data:s,files:a}=this.buildPayload(),o=await this.attachCaptchaToken(s);if(o!==!0){const d=typeof o=="string"?o:this.config.captchaFailedMessage;this.showMessage("error",d),requestAnimationFrame(()=>this.focusFirstInvalid());return}s.formId=this.formId;const n=this.buildRequestOptions(s,a),i=await fetch(`${this.restUrl}/submission`,n),c=await i.json().catch(()=>({})),l=c.data||c,u=i.ok&&(c.success||l.success);if(console.log("[NXP Debug] Response:",{response:c,actualData:l,isSuccess:u,responseOk:i.ok}),!u){const d=((t=l==null?void 0:l.errors)==null?void 0:t.fields)||((r=c==null?void 0:c.errors)==null?void 0:r.fields);console.log("[NXP Debug] Error fields:",d),d&&this.applyErrors(d);const p=l.message||c.message||this.errorMessage;this.showMessage("error",p),requestAnimationFrame(()=>this.focusFirstInvalid());return}this.showMessage("success",l.message||c.message||this.successMessage),this.formElement.reset(),this.resetCaptcha()}catch{this.showMessage("error",this.errorMessage)}finally{this.setSubmitting(!1)}}buildPayload(){const e=new FormData(this.formElement),t={},r={},s={};return e.forEach((a,o)=>{a instanceof File?a&&a.name&&(r[o]=a):t[o]=a}),this.formElement.querySelectorAll('input[type="checkbox"][name]').forEach(a=>{const o=a.name;if(s[o]||(s[o]={total:0,values:[]}),s[o].total+=1,a.checked){const n=a.value||"on";s[o].values.push(n)}!a.checked&&s[o].total===1&&!(o in t)&&(t[o]=!1)}),Object.entries(s).forEach(([a,o])=>{o.total>1?t[a]=o.values:t[a]=o.values.length>0}),this.formElement.querySelectorAll("select[multiple][name]").forEach(a=>{const o=Array.from(a.selectedOptions).map(n=>n.value);t[a.name]=o}),Object.keys(r).forEach(a=>{delete t[a]}),{data:t,files:r}}buildRequestOptions(e,t){if(!(Object.keys(t).length>0))return{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)};const s=new FormData;return s.append("payload",JSON.stringify(e)),Object.entries(t).forEach(([a,o])=>{s.append(`files[${a}]`,o)}),{method:"POST",body:s}}async attachCaptchaToken(e){return!this.captchaConfig||this.captchaConfig.provider==="none"?(delete e._nxp_captcha_token,delete e._nxp_captcha_provider,!0):(e._nxp_captcha_provider=this.captchaConfig.provider,this.captchaConfig.provider==="recaptcha_v3"?await this.handleRecaptchaV3(e):this.captchaConfig.provider==="turnstile"?this.handleTurnstile(e):this.captchaConfig.provider==="friendlycaptcha"?this.handleFriendlyCaptcha(e):!0)}async handleRecaptchaV3(e){if(!this.captchaConfig.siteKey)return this.config.captchaFailedMessage;try{if(await this.scriptLoader.loadCaptchaScript("recaptcha_v3",this.captchaConfig.siteKey),!window.grecaptcha||!window.grecaptcha.execute)return this.config.captchaFailedMessage;const t=await new Promise((s,a)=>{window.grecaptcha.ready(()=>{window.grecaptcha.execute(this.captchaConfig.siteKey,{action:"nxp_easy_forms_submit"}).then(s).catch(a)})});if(!t)return this.config.captchaFailedMessage;e._nxp_captcha_token=t;const r=this.formElement.querySelector('input[name="_nxp_captcha_token"]');return r&&(r.value=t),!0}catch{return this.config.captchaFailedMessage}}async handleTurnstile(e){await this.scriptLoader.loadCaptchaScript("turnstile");const t=this.formElement.querySelector('input[name="cf-turnstile-response"]'),r=(e["cf-turnstile-response"]||(t==null?void 0:t.value)||"").trim();if(!r)return this.config.captchaIncompleteMessage;e._nxp_captcha_token=r,delete e["cf-turnstile-response"];const s=this.formElement.querySelector('input[name="_nxp_captcha_token"]');return s&&(s.value=r),!0}async handleFriendlyCaptcha(e){var s,a;await this.scriptLoader.loadCaptchaScript("friendlycaptcha");const t=(e["frc-captcha-response"]||e["frc-captcha-solution"]||((s=this.formElement.querySelector('input[name="frc-captcha-response"]'))==null?void 0:s.value)||((a=this.formElement.querySelector('input[name="frc-captcha-solution"]'))==null?void 0:a.value)||"").trim();if(!t)return this.config.captchaIncompleteMessage;e._nxp_captcha_token=t,delete e["frc-captcha-response"],delete e["frc-captcha-solution"];const r=this.formElement.querySelector('input[name="_nxp_captcha_token"]');return r&&(r.value=t),!0}resetCaptcha(){var t,r,s;if(!this.captchaConfig||this.captchaConfig.provider==="none")return;if(this.captchaConfig.provider==="turnstile"&&((t=window.turnstile)!=null&&t.reset)&&window.turnstile.reset(),this.captchaConfig.provider==="friendlycaptcha"&&((s=(r=window.friendlyChallenge)==null?void 0:r.widgets)!=null&&s.reset))try{window.friendlyChallenge.widgets.reset()}catch{}const e=this.formElement.querySelector('input[name="_nxp_captcha_token"]');e&&(e.value="")}showMessage(e,t){if(!this.messageEl)return;this.messageEl.innerHTML="";const r=document.createElement("div");r.className=`nxp-easy-form__notice nxp-easy-form__notice--${e}`,r.id=`nxp-ef-message-${this.formId}`,r.setAttribute("role","status"),r.setAttribute("tabindex","-1"),r.textContent=t,this.messageEl.appendChild(r),requestAnimationFrame(()=>{r.scrollIntoView({behavior:"smooth",block:"nearest"}),setTimeout(()=>{r.focus({preventScroll:!0})},300)})}clearMessages(){this.messageEl&&(this.messageEl.innerHTML="")}setSubmitting(e){this.isSubmitting=e,this.submitButton&&(this.submitButton.disabled=e),this.wrapper.classList.toggle("nxp-easy-form--submitting",e)}applyErrors(e){console.log("[NXP Debug] applyErrors called with:",e);let t=!1;Object.entries(e).forEach(([r,s])=>{var n;console.log("[NXP Debug] Processing error for field:",r,"message:",s);const a=this.formElement.querySelector(`[data-error-for="${this.escapeSelector(r)}"]`)||this.ensureErrorHolder(r);if(console.log("[NXP Debug] Error holder for",r,":",a),!a){console.log("[NXP Debug] No error holder found for",r);return}t=!0;const o=this.formElement.querySelector(this.getFieldSelector(r));if(console.log("[NXP Debug] Control for",r,":",o),o){o.setAttribute("aria-invalid","true");const i=this.ensureErrorId(a,o);o.setAttribute("aria-describedby",i)}a.textContent=s,(n=a.closest(".nxp-easy-form__group"))==null||n.classList.add("nxp-easy-form__group--error")}),t&&requestAnimationFrame(()=>this.focusFirstInvalid())}clearErrors(){this.formElement.querySelectorAll(".nxp-easy-form__group--error").forEach(e=>{e.classList.remove("nxp-easy-form__group--error")}),this.formElement.querySelectorAll(".nxp-easy-form__error").forEach(e=>{const t=this.formElement.querySelector(this.getFieldSelector(e.dataset.errorFor));t&&(t.removeAttribute("aria-invalid"),t.getAttribute("aria-describedby")===e.id&&t.removeAttribute("aria-describedby")),e.textContent=""})}ensureErrorHolder(e){const t=this.formElement.querySelector(this.getFieldSelector(e)),r=t==null?void 0:t.closest(".nxp-easy-form__group");if(!r)return null;const s=document.createElement("p");return s.className="nxp-easy-form__error",s.dataset.errorFor=e,s.setAttribute("role","alert"),r.appendChild(s),s}ensureErrorId(e,t){if(e.id)return e.id;const a=`${(t.id||t.name||"nxp-ef-field").replace(/[^a-z0-9_-]/gi,"")||"nxp-ef-field"}-error`;return e.id=a,a}focusFirstInvalid(){const e=this.formElement.querySelector('[aria-invalid="true"]');e&&e.focus({preventScroll:!1})}getFieldSelector(e){const t=this.escapeSelector(e);return`[name="${t}"], [id="${t}"]`}escapeSelector(e){var t;return(t=window.CSS)!=null&&t.escape?window.CSS.escape(String(e)):String(e).replace(/([ #;?%&,.+*~':"!^$\[\]\\(){}|<>@])/g,"\\$1")}}class g{constructor(e){this.restUrl=e,this.cache={countries:{},states:{}},this._debug=typeof window<"u"&&!!(window.nxpEasyFormsFrontend&&window.nxpEasyFormsFrontend.debug===!0),this._dbg=(...t)=>{this._debug&&console&&console.debug&&console.debug(...t)},this.init()}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.initFields()):this.initFields()}initFields(){document.querySelectorAll(".nxp-easy-form__country").forEach(r=>this.initCountryField(r)),document.querySelectorAll(".nxp-easy-form__state").forEach(r=>this.initStateField(r))}async initCountryField(e){var s;const t=e.dataset.countryFilter||"all",r=((s=e.querySelector('option[value=""]'))==null?void 0:s.textContent)||"Select a country";try{const a=await this.fetchCountries(t);this.populateCountrySelect(e,a,r),e.addEventListener("change",()=>this.handleCountryChange(e))}catch(a){this._dbg("[Country] Failed to load countries:",a)}}async initStateField(e){let t=e.dataset.countryField;this._dbg("[State] Initializing field, linked to country field:",t);const r=e.closest("form");if(!r){console.warn("[State] No parent form found");return}if(!t){const a=r.querySelectorAll(".nxp-easy-form__country");if(a.length===1&&(t=a[0].getAttribute("name")||"",t&&(e.dataset.countryField=t)),!t){const n=(e.getAttribute("name")||"").match(/^(.*)_state$/);if(n&&n[1]){const i=`${n[1]}_country`;r.querySelector(`[name="${i}"]`)&&(t=i,e.dataset.countryField=t)}}}if(!t){console.warn("[State] No country field specified in data-country-field and auto-link failed");return}const s=r.querySelector(`[name="${t}"]`);if(!s){console.warn("[State] Country field not found:",t);return}s.value&&await this.loadStatesForCountry(e,s.value)}async handleCountryChange(e){const t=e.value,r=e.closest("form");if(!r){console.warn("[Country] No parent form found");return}const s=e.getAttribute("name"),a=r.querySelectorAll(`.nxp-easy-form__state[data-country-field="${s}"]`),o=r.querySelectorAll(`input[data-original-select-html][data-country-field="${s}"]`);let n=[...a,...o];if(!n.length){const i=r.querySelectorAll(".nxp-easy-form__state"),c=r.querySelectorAll("input[data-original-select-html]"),l=r.querySelectorAll(".nxp-easy-form__country");if(i.length+c.length===1&&l.length===1){const d=i[0]||c[0];d.dataset.countryField=s||"",n=[d]}}n.forEach(async i=>{t?await this.loadStatesForCountry(i,t):this.clearStateField(i)})}async loadStatesForCountry(e,t){var a;const r=((a=e.querySelector('option[value=""]'))==null?void 0:a.textContent)||"Select a state",s=e.dataset.allowText==="1";try{const o=await this.fetchStates(t);if(Object.keys(o).length>0){const n=this.ensureSelectMode(e);this.populateStateSelect(n,o,r)}else s?this.convertToTextInput(e):(this.clearStateField(e),e.disabled=!0)}catch(o){this._dbg("Failed to load states:",o)}}async fetchCountries(e="all"){const t=e;if(this.cache.countries[t])return this.cache.countries[t];const s=await(await fetch(`${this.restUrl}/utility/countries?mode=${e}`)).json();return s.success&&s.countries?(this.cache.countries[t]=s.countries,s.countries):{}}async fetchStates(e){const t=String(e||"").toUpperCase();if(!t||t.length!==2)return{};if(this.cache.states[t])return this.cache.states[t];const r=await fetch(`${this.restUrl}/utility/states/${t}`,{headers:{Accept:"application/json"},credentials:"same-origin"});if(!r.ok)return this._dbg("[State] HTTP error when fetching states:",r.status,r.statusText),{};const s=await r.json().catch(()=>({}));return s&&s.success&&s.states&&typeof s.states=="object"?(this.cache.states[t]=s.states,s.states):{}}populateCountrySelect(e,t,r){e.innerHTML=`<option value="">${r}</option>`,Object.entries(t).forEach(([s,a])=>{const o=document.createElement("option");o.value=s,o.textContent=a,e.appendChild(o)})}populateStateSelect(e,t,r){e.innerHTML=`<option value="">${r}</option>`,Object.entries(t).forEach(([s,a])=>{const o=document.createElement("option");o.value=s,o.textContent=a,e.appendChild(o)}),e.disabled=!1}clearStateField(e){var r;if(!e)return;if(e.tagName==="INPUT"){e.value="";return}const t=((r=e.querySelector('option[value=""]'))==null?void 0:r.textContent)||"Select a state";e.innerHTML=`<option value="">${t}</option>`,e.value=""}convertToTextInput(e){var r;const t=document.createElement("input");t.type="text",t.name=e.name,t.id=e.id,t.className=e.className.replace("nxp-easy-form__state","nxp-easy-form__input"),t.placeholder=((r=e.querySelector('option[value=""]'))==null?void 0:r.textContent)||"",t.required=e.hasAttribute("required"),t.dataset.originalSelectHtml=e.outerHTML,e.dataset.countryField&&(t.dataset.countryField=e.dataset.countryField),e.dataset.allowText&&(t.dataset.allowText=e.dataset.allowText),e.parentNode.replaceChild(t,e)}ensureSelectMode(e){if(e.tagName==="INPUT"&&e.dataset.originalSelectHtml){const t=document.createElement("div");t.innerHTML=e.dataset.originalSelectHtml;const r=t.firstElementChild||t.firstChild;return e.parentNode.replaceChild(r,e),r}return e}}(()=>{var a;const h=document.querySelectorAll(".nxp-easy-form");if(!h.length)return;const e=window.nxpEasyFormsFrontend||{},t=((a=window.wpApiSettings)==null?void 0:a.root)||`${window.location.origin}/wp-json/`,r=e.restUrl||`${t.replace(/\/$/,"")}/nxp-easy-forms/v1`,s={restUrl:r,successMessage:e.successMessage||"Thanks!",errorMessage:e.errorMessage||"Submission failed. Please try again.",captchaFailedMessage:e.captchaFailedMessage||"Security verification failed. Please try again.",captchaIncompleteMessage:e.captchaIncompleteMessage||"Please complete the verification.",scriptLoader:new f};new g(r),h.forEach(o=>{if(o.dataset.nxpEfBooted==="1")return;const n=o.querySelector(".nxp-easy-form__form"),i=Number(o.dataset.formId||0);!n||!r||!i||(o.dataset.nxpEfBooted="1",new m(o,s))})})();
