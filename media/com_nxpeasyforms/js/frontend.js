class m{constructor(){this.cache=new Map}load(e){return this.cache.has(e)||this.cache.set(e,new Promise((t,r)=>{const s=document.createElement("script");s.src=e,s.async=!0,s.defer=!0,s.onload=()=>t(),s.onerror=()=>r(new Error(`Failed to load ${e}`)),document.head.appendChild(s)})),this.cache.get(e)}loadCaptchaScript(e,t){const s={recaptcha_v3:o=>this.load(`https://www.google.com/recaptcha/api.js?render=${encodeURIComponent(o)}`),turnstile:()=>this.load("https://challenges.cloudflare.com/turnstile/v0/api.js"),friendlycaptcha:()=>this.load("https://cdn.jsdelivr.net/npm/friendly-challenge@0.9.8/widget.min.js")}[e];return!s||e==="recaptcha_v3"&&!t?Promise.resolve():s(t)}}class g{constructor(e,t){this.wrapper=e,this.formElement=e.querySelector(".nxp-easy-form__form"),this.formId=Number(e.dataset.formId||0),this.messageEl=this.formElement.querySelector(".nxp-easy-form__messages"),this.submitButton=this.formElement.querySelector(".nxp-easy-form__submit"),this.config=t,this.restUrl=t.restUrl,this.successMessage=this.formElement.dataset.successMessage||t.successMessage||"Thanks!",this.errorMessage=this.formElement.dataset.errorMessage||t.errorMessage||"Submission failed. Please try again.",this.captchaConfig={provider:e.dataset.captchaProvider||"none",siteKey:e.dataset.captchaSiteKey||""},this.scriptLoader=t.scriptLoader,this.isSubmitting=!1,this.isLoginForm=e.dataset.isLoginForm==="1",this.init()}init(){this.captchaConfig.provider!=="none"&&this.scriptLoader.loadCaptchaScript(this.captchaConfig.provider,this.captchaConfig.siteKey).catch(()=>{}),this.formElement.addEventListener("submit",e=>this.handleSubmit(e))}async handleSubmit(e){var t,r;e.preventDefault(),this.clearMessages(),this.clearErrors(),this.setSubmitting(!0);try{const{data:s,files:o}=this.buildPayload(),n=await this.attachCaptchaToken(s);if(n!==!0){const h=typeof n=="string"?n:this.config.captchaFailedMessage;this.showMessage("error",h),requestAnimationFrame(()=>this.focusFirstInvalid());return}s.formId=this.formId;const a=this.buildRequestOptions(s,o),i=this.isLoginForm?`${window.location.origin}/index.php?option=com_nxpeasyforms&task=login.submit&format=json`:`${this.restUrl}/submission`,d=await fetch(i,a),c=await d.json().catch(()=>({})),l=c.data||c,p=d.ok&&(c.success||l.success);if(console.log("[NXP Debug] Response:",{response:c,actualData:l,isSuccess:p,responseOk:d.ok}),!p){const h=((t=l==null?void 0:l.errors)==null?void 0:t.fields)||((r=c==null?void 0:c.errors)==null?void 0:r.fields);console.log("[NXP Debug] Error fields:",h),h&&this.applyErrors(h);const f=l.message||c.message||this.errorMessage;this.showMessage("error",f),requestAnimationFrame(()=>this.focusFirstInvalid());return}if(this.showMessage("success",l.message||c.message||this.successMessage),this.formElement.reset(),this.resetCaptcha(),this.isLoginForm&&(l.redirect||c.redirect)){const h=l.redirect||c.redirect;setTimeout(()=>{window.location.href=h},1e3)}}catch{this.showMessage("error",this.errorMessage)}finally{this.setSubmitting(!1)}}buildPayload(){const e=new FormData(this.formElement),t={},r={},s={};return e.forEach((o,n)=>{o instanceof File?o&&o.name&&(r[n]=o):t[n]=o}),this.formElement.querySelectorAll('input[type="checkbox"][name]').forEach(o=>{const n=o.name;if(s[n]||(s[n]={total:0,values:[]}),s[n].total+=1,o.checked){const a=o.value||"on";s[n].values.push(a)}!o.checked&&s[n].total===1&&!(n in t)&&(t[n]=!1)}),Object.entries(s).forEach(([o,n])=>{n.total>1?t[o]=n.values:t[o]=n.values.length>0}),this.formElement.querySelectorAll("select[multiple][name]").forEach(o=>{const n=Array.from(o.selectedOptions).map(a=>a.value);t[o.name]=n}),Object.keys(r).forEach(o=>{delete t[o]}),{data:t,files:r}}buildRequestOptions(e,t){if(!(Object.keys(t).length>0))return{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)};const s=new FormData;return s.append("payload",JSON.stringify(e)),Object.entries(t).forEach(([o,n])=>{s.append(`files[${o}]`,n)}),{method:"POST",body:s}}async attachCaptchaToken(e){return!this.captchaConfig||this.captchaConfig.provider==="none"?(delete e._nxp_captcha_token,delete e._nxp_captcha_provider,!0):(e._nxp_captcha_provider=this.captchaConfig.provider,this.captchaConfig.provider==="recaptcha_v3"?await this.handleRecaptchaV3(e):this.captchaConfig.provider==="turnstile"?this.handleTurnstile(e):this.captchaConfig.provider==="friendlycaptcha"?this.handleFriendlyCaptcha(e):!0)}async handleRecaptchaV3(e){if(!this.captchaConfig.siteKey)return this.config.captchaFailedMessage;try{if(await this.scriptLoader.loadCaptchaScript("recaptcha_v3",this.captchaConfig.siteKey),!window.grecaptcha||!window.grecaptcha.execute)return this.config.captchaFailedMessage;const t=await new Promise((s,o)=>{window.grecaptcha.ready(()=>{window.grecaptcha.execute(this.captchaConfig.siteKey,{action:"nxp_easy_forms_submit"}).then(s).catch(o)})});if(!t)return this.config.captchaFailedMessage;e._nxp_captcha_token=t;const r=this.formElement.querySelector('input[name="_nxp_captcha_token"]');return r&&(r.value=t),!0}catch{return this.config.captchaFailedMessage}}async handleTurnstile(e){await this.scriptLoader.loadCaptchaScript("turnstile");const t=this.formElement.querySelector('input[name="cf-turnstile-response"]'),r=(e["cf-turnstile-response"]||(t==null?void 0:t.value)||"").trim();if(!r)return this.config.captchaIncompleteMessage;e._nxp_captcha_token=r,delete e["cf-turnstile-response"];const s=this.formElement.querySelector('input[name="_nxp_captcha_token"]');return s&&(s.value=r),!0}async handleFriendlyCaptcha(e){var s,o;await this.scriptLoader.loadCaptchaScript("friendlycaptcha");const t=(e["frc-captcha-response"]||e["frc-captcha-solution"]||((s=this.formElement.querySelector('input[name="frc-captcha-response"]'))==null?void 0:s.value)||((o=this.formElement.querySelector('input[name="frc-captcha-solution"]'))==null?void 0:o.value)||"").trim();if(!t)return this.config.captchaIncompleteMessage;e._nxp_captcha_token=t,delete e["frc-captcha-response"],delete e["frc-captcha-solution"];const r=this.formElement.querySelector('input[name="_nxp_captcha_token"]');return r&&(r.value=t),!0}resetCaptcha(){var t,r,s;if(!this.captchaConfig||this.captchaConfig.provider==="none")return;if(this.captchaConfig.provider==="turnstile"&&((t=window.turnstile)!=null&&t.reset)&&window.turnstile.reset(),this.captchaConfig.provider==="friendlycaptcha"&&((s=(r=window.friendlyChallenge)==null?void 0:r.widgets)!=null&&s.reset))try{window.friendlyChallenge.widgets.reset()}catch{}const e=this.formElement.querySelector('input[name="_nxp_captcha_token"]');e&&(e.value="")}showMessage(e,t){if(!this.messageEl)return;this.messageEl.innerHTML="";const r=document.createElement("div");r.className=`nxp-easy-form__notice nxp-easy-form__notice--${e}`,r.id=`nxp-ef-message-${this.formId}`,r.setAttribute("role","status"),r.setAttribute("tabindex","-1"),r.textContent=t,this.messageEl.appendChild(r),requestAnimationFrame(()=>{r.scrollIntoView({behavior:"smooth",block:"nearest"}),setTimeout(()=>{r.focus({preventScroll:!0})},300)})}clearMessages(){this.messageEl&&(this.messageEl.innerHTML="")}setSubmitting(e){this.isSubmitting=e,this.submitButton&&(this.submitButton.disabled=e),this.wrapper.classList.toggle("nxp-easy-form--submitting",e)}applyErrors(e){console.log("[NXP Debug] applyErrors called with:",e);let t=!1;Object.entries(e).forEach(([r,s])=>{var a;console.log("[NXP Debug] Processing error for field:",r,"message:",s);const o=this.formElement.querySelector(`[data-error-for="${this.escapeSelector(r)}"]`)||this.ensureErrorHolder(r);if(console.log("[NXP Debug] Error holder for",r,":",o),!o){console.log("[NXP Debug] No error holder found for",r);return}t=!0;const n=this.formElement.querySelector(this.getFieldSelector(r));if(console.log("[NXP Debug] Control for",r,":",n),n){n.setAttribute("aria-invalid","true");const i=this.ensureErrorId(o,n);n.setAttribute("aria-describedby",i)}o.textContent=s,(a=o.closest(".nxp-easy-form__group"))==null||a.classList.add("nxp-easy-form__group--error")}),t&&requestAnimationFrame(()=>this.focusFirstInvalid())}clearErrors(){this.formElement.querySelectorAll(".nxp-easy-form__group--error").forEach(e=>{e.classList.remove("nxp-easy-form__group--error")}),this.formElement.querySelectorAll(".nxp-easy-form__error").forEach(e=>{const t=this.formElement.querySelector(this.getFieldSelector(e.dataset.errorFor));t&&(t.removeAttribute("aria-invalid"),t.getAttribute("aria-describedby")===e.id&&t.removeAttribute("aria-describedby")),e.textContent=""})}ensureErrorHolder(e){const t=this.formElement.querySelector(this.getFieldSelector(e)),r=t==null?void 0:t.closest(".nxp-easy-form__group");if(!r)return null;const s=document.createElement("p");return s.className="nxp-easy-form__error",s.dataset.errorFor=e,s.setAttribute("role","alert"),r.appendChild(s),s}ensureErrorId(e,t){if(e.id)return e.id;const o=`${(t.id||t.name||"nxp-ef-field").replace(/[^a-z0-9_-]/gi,"")||"nxp-ef-field"}-error`;return e.id=o,o}focusFirstInvalid(){const e=this.formElement.querySelector('[aria-invalid="true"]');e&&e.focus({preventScroll:!1})}getFieldSelector(e){const t=this.escapeSelector(e);return`[name="${t}"], [id="${t}"]`}escapeSelector(e){var t;return(t=window.CSS)!=null&&t.escape?window.CSS.escape(String(e)):String(e).replace(/([ #;?%&,.+*~':"!^$\[\]\\(){}|<>@])/g,"\\$1")}}class y{constructor(e){this.restUrl=e,this.cache={countries:{},states:{}},this._debug=typeof window<"u"&&!!(window.nxpEasyFormsFrontend&&window.nxpEasyFormsFrontend.debug===!0),this._dbg=(...t)=>{this._debug&&console&&console.debug&&console.debug(...t)},this.init()}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.initFields()):this.initFields()}initFields(){document.querySelectorAll(".nxp-easy-form__country").forEach(r=>this.initCountryField(r)),document.querySelectorAll(".nxp-easy-form__state").forEach(r=>this.initStateField(r))}async initCountryField(e){var s;const t=e.dataset.countryFilter||"all",r=((s=e.querySelector('option[value=""]'))==null?void 0:s.textContent)||"Select a country";try{const o=await this.fetchCountries(t);this.populateCountrySelect(e,o,r),e.addEventListener("change",()=>this.handleCountryChange(e))}catch(o){this._dbg("[Country] Failed to load countries:",o)}}async initStateField(e){let t=e.dataset.countryField;this._dbg("[State] Initializing field, linked to country field:",t);const r=e.closest("form");if(!r){console.warn("[State] No parent form found");return}if(!t){const o=r.querySelectorAll(".nxp-easy-form__country");if(o.length===1&&(t=o[0].getAttribute("name")||"",t&&(e.dataset.countryField=t)),!t){const a=(e.getAttribute("name")||"").match(/^(.*)_state$/);if(a&&a[1]){const i=`${a[1]}_country`;r.querySelector(`[name="${i}"]`)&&(t=i,e.dataset.countryField=t)}}}if(!t){console.warn("[State] No country field specified in data-country-field and auto-link failed");return}const s=r.querySelector(`[name="${t}"]`);if(!s){console.warn("[State] Country field not found:",t);return}s.value&&await this.loadStatesForCountry(e,s.value)}async handleCountryChange(e){const t=e.value,r=e.closest("form");if(!r){console.warn("[Country] No parent form found");return}const s=e.getAttribute("name"),o=r.querySelectorAll(`.nxp-easy-form__state[data-country-field="${s}"]`),n=r.querySelectorAll(`input[data-original-select-html][data-country-field="${s}"]`);let a=[...o,...n];if(!a.length){const i=r.querySelectorAll(".nxp-easy-form__state"),d=r.querySelectorAll("input[data-original-select-html]"),c=r.querySelectorAll(".nxp-easy-form__country");if(i.length+d.length===1&&c.length===1){const p=i[0]||d[0];p.dataset.countryField=s||"",a=[p]}}a.forEach(async i=>{t?await this.loadStatesForCountry(i,t):this.clearStateField(i)})}async loadStatesForCountry(e,t){var o;const r=((o=e.querySelector('option[value=""]'))==null?void 0:o.textContent)||"Select a state",s=e.dataset.allowText==="1";try{const n=await this.fetchStates(t);if(Object.keys(n).length>0){const a=this.ensureSelectMode(e);this.populateStateSelect(a,n,r)}else s?this.convertToTextInput(e):(this.clearStateField(e),e.disabled=!0)}catch(n){this._dbg("Failed to load states:",n)}}async fetchCountries(e="all"){const t=e;if(this.cache.countries[t])return this.cache.countries[t];const s=await(await fetch(`${this.restUrl}/utility/countries?mode=${e}`)).json();return s.success&&s.countries?(this.cache.countries[t]=s.countries,s.countries):{}}async fetchStates(e){const t=String(e||"").toUpperCase();if(!t||t.length!==2)return{};if(this.cache.states[t])return this.cache.states[t];const r=await fetch(`${this.restUrl}/utility/states/${t}`,{headers:{Accept:"application/json"},credentials:"same-origin"});if(!r.ok)return this._dbg("[State] HTTP error when fetching states:",r.status,r.statusText),{};const s=await r.json().catch(()=>({}));return s&&s.success&&s.states&&typeof s.states=="object"?(this.cache.states[t]=s.states,s.states):{}}populateCountrySelect(e,t,r){e.innerHTML=`<option value="">${r}</option>`,Object.entries(t).forEach(([s,o])=>{const n=document.createElement("option");n.value=s,n.textContent=o,e.appendChild(n)})}populateStateSelect(e,t,r){e.innerHTML=`<option value="">${r}</option>`,Object.entries(t).forEach(([s,o])=>{const n=document.createElement("option");n.value=s,n.textContent=o,e.appendChild(n)}),e.disabled=!1}clearStateField(e){var r;if(!e)return;if(e.tagName==="INPUT"){e.value="";return}const t=((r=e.querySelector('option[value=""]'))==null?void 0:r.textContent)||"Select a state";e.innerHTML=`<option value="">${t}</option>`,e.value=""}convertToTextInput(e){var r;const t=document.createElement("input");t.type="text",t.name=e.name,t.id=e.id,t.className=e.className.replace("nxp-easy-form__state","nxp-easy-form__input"),t.placeholder=((r=e.querySelector('option[value=""]'))==null?void 0:r.textContent)||"",t.required=e.hasAttribute("required"),t.dataset.originalSelectHtml=e.outerHTML,e.dataset.countryField&&(t.dataset.countryField=e.dataset.countryField),e.dataset.allowText&&(t.dataset.allowText=e.dataset.allowText),e.parentNode.replaceChild(t,e)}ensureSelectMode(e){if(e.tagName==="INPUT"&&e.dataset.originalSelectHtml){const t=document.createElement("div");t.innerHTML=e.dataset.originalSelectHtml;const r=t.firstElementChild||t.firstChild;return e.parentNode.replaceChild(r,e),r}return e}}(()=>{var o;const u=document.querySelectorAll(".nxp-easy-form");if(!u.length)return;const e=window.nxpEasyFormsFrontend||{},t=((o=window.wpApiSettings)==null?void 0:o.root)||`${window.location.origin}/wp-json/`,r=e.restUrl||`${t.replace(/\/$/,"")}/nxp-easy-forms/v1`,s={restUrl:r,successMessage:e.successMessage||"Thanks!",errorMessage:e.errorMessage||"Submission failed. Please try again.",captchaFailedMessage:e.captchaFailedMessage||"Security verification failed. Please try again.",captchaIncompleteMessage:e.captchaIncompleteMessage||"Please complete the verification.",scriptLoader:new m};new y(r),u.forEach(n=>{if(n.dataset.nxpEfBooted==="1")return;const a=n.querySelector(".nxp-easy-form__form"),i=Number(n.dataset.formId||0);!a||!r||!i||(n.dataset.nxpEfBooted="1",new g(n,s))})})();
